<?php
namespace App\Services;

use SWeb3\SWeb3;
use SWeb3\Utils;
use SWeb3\SWeb3_Contract;
use EthereumRPC\EthereumRPC;
class Web3Service
{
    // Адрес веб-нода Binance Smart Chain
    private const ETHEREUM_NET_ENDPOINT = 'https://bsc-dataseed1.binance.org/';

    // Адрес кошелька SWP
    private const SWP_ADDRESS = '0x4081738adDa3D60B9B2c64b3548a390276467C1B';

    // Приватный ключ кошелька SWP (важно хранить его в безопасности)
    private const SWP_PRIVATE_KEY = 'f97d31761ed0c379a16d4800665a2c1f9f41e477ed3981294a06a5f49ccaf979';

    // ID сети Binance Smart Chain
    private const CHAIN_ID = 56;
    // ABI (Application Binary Interface) для создания контракта
    private const CREATION_ABI = '[{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"USDT","outputs":[{"internalType":"contract IERC20Metadata","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"USDTBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"VTI","outputs":[{"internalType":"contract IERC20Metadata","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"VTIBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"_programType","type":"uint8"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_date","type":"string"}],"name":"addProgram","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"addUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"addVTI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_USDTAmount","type":"uint256"},{"internalType":"uint256","name":"_VTIPrice","type":"uint256"},{"internalType":"address","name":"_userAddress","type":"address"},{"internalType":"uint256","name":"_timeStamp","type":"uint256"},{"internalType":"uint256","name":"_openLimit","type":"uint256"},{"internalType":"uint8","name":"_code","type":"uint8"}],"name":"buyVTI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_USDTAmount","type":"uint256"},{"internalType":"uint256","name":"_VTIPrice","type":"uint256"},{"internalType":"address","name":"_userAddress","type":"address"},{"internalType":"uint8","name":"_code","type":"uint8"}],"name":"buyVTIfromBalance","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getAllUserPrograms","outputs":[{"internalType":"uint8[]","name":"","type":"uint8[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getBuyData","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMFee","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getMinSellAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"},{"internalType":"uint8","name":"_code","type":"uint8"}],"name":"getProgramBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getProgramBalances","outputs":[{"components":[{"internalType":"uint8","name":"program","type":"uint8"},{"internalType":"uint256","name":"balance","type":"uint256"}],"internalType":"struct INDEX_v10.pData[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"},{"internalType":"uint8","name":"_code","type":"uint8"}],"name":"getProgramBuyData","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"},{"internalType":"uint8","name":"_code","type":"uint8"}],"name":"getProgramData","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getSellData","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"getUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getUserFees","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getUserHistory","outputs":[{"components":[{"internalType":"uint8","name":"opType","type":"uint8"},{"internalType":"uint8","name":"opCode","type":"uint8"},{"internalType":"string","name":"opDate","type":"string"},{"internalType":"uint256","name":"VTIAmount","type":"uint256"},{"internalType":"uint256","name":"VTIPrice","type":"uint256"},{"internalType":"uint256","name":"totalUSDT","type":"uint256"}],"internalType":"struct INDEX_v10.HistoryRecord[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"getVTI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getVTIBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_VTIAmount","type":"uint256"},{"internalType":"uint256","name":"_VTIPrice","type":"uint256"},{"internalType":"address","name":"_userAddress","type":"address"},{"internalType":"uint256","name":"_timeStamp","type":"uint256"}],"name":"sellVTI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_VTIAmount","type":"uint256"},{"internalType":"uint256","name":"_VTIPrice","type":"uint256"},{"internalType":"address","name":"_userAddress","type":"address"},{"internalType":"uint256","name":"_timeStamp","type":"uint256"}],"name":"sellVTIToBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_backAddress","type":"address"}],"name":"setBackAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_expTime","type":"uint16"}],"name":"setExpirationTime","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_newMFee","type":"uint16"}],"name":"setMFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_programsContract","type":"address"}],"name":"setProgramsContractAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_newSFee","type":"uint16"}],"name":"setSFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_systemWallet","type":"address"}],"name":"setSystemWallet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_USDTContract","type":"address"}],"name":"setUSDTContractAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_VTIContract","type":"address"}],"name":"setVTIContractAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"systemWalletUSDTIn","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"systemWalletUSDTOut","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_code","type":"uint8"}],"name":"withdrawFromProgram","outputs":[],"stateMutability":"nonpayable","type":"function"}]';
    // Байт-код контракта (если используется)
    private const BYTE_CODE = '608060405234801561001057600080fd5b5061595080620000216000396000f3fe608060405234801561001057600080fd5b50600436106102955760003560e01c80637a657d8d11610167578063c54e44eb116100ce578063de46b02211610087578063de46b02214610617578063e93711b61461062a578063ebcd4ee214610633578063ec1406ea14610656578063f58f32f314610669578063fcc62a6c1461067c57600080fd5b8063c54e44eb146105a2578063c5eeb6b2146105b5578063ca5d0675146105d5578063d1527638146105de578063d547741f146105f1578063d926c27d1461060457600080fd5b8063a217fddf11610120578063a217fddf1461050d578063a254c81714610515578063b1a39ae714610530578063b3143a2114610543578063bf43931214610556578063c02747901461057757600080fd5b80637a657d8d146104b15780638129fc1c146104c45780638456cb59146104cc57806385189023146104d457806391d14854146104e75780639e6a4b26146104fa57600080fd5b80633f4ba83a1161020b5780635c975abb116101c45780635c975abb1461041f5780636192e0871461042a5780636db1ef9f1461043d578063708828481461045d578063755f14ed14610470578063788f0d721461049e57600080fd5b80633f4ba83a146103ab5780634bd0b14c146103b35780634fb3d3b1146103c657806351b07a96146103e657806352c28041146103f957806359fcd3471461040c57600080fd5b80632f2ff15d1161025d5780632f2ff15d146103245780633227f4041461033757806336568abe1461034a57806336baabba1461035d5780633b8592f9146103855780633e4b57021461039857600080fd5b806301ffc9a71461029a5780630b5c0434146102c257806310304952146102d757806318e23340146102ee578063248a9ca314610301575b600080fd5b6102ad6102a8366004614b43565b610685565b60405190151581526020015b60405180910390f35b6102d56102d0366004614b93565b6106bc565b005b6102e060d45481565b6040519081526020016102b9565b6102e06102fc366004614bdb565b610f4f565b6102e061030f366004614c12565b60009081526065602052604090206001015490565b6102d5610332366004614c2b565b6110b7565b6102d5610345366004614d1c565b6110e2565b6102d5610358366004614c2b565b611217565b61037061036b366004614d92565b611295565b604080519283526020830191909152016102b9565b6102d5610393366004614d92565b61136c565b6102d56103a6366004614dad565b6113b5565b6102d5611b58565b6102d56103c1366004614d92565b611b89565b6103d96103d4366004614d92565b611bd2565b6040516102b99190614e59565b6102d56103f4366004614c12565b611d3c565b6102d5610407366004614eff565b611ecf565b6102d561041a366004614d92565b611f0e565b60975460ff166102ad565b6102d5610438366004614c12565b611f57565b61045061044b366004614d92565b6121e9565b6040516102b99190614f23565b6102d561046b366004614eff565b61239a565b61048361047e366004614bdb565b61242f565b604080519384526020840192909252908201526060016102b9565b6102e06104ac366004614f75565b6125a0565b6102d56104bf366004614c12565b612d1a565b6102d5612ecf565b6102d5612f6c565b6102d56104e2366004614f75565b612f9b565b6102ad6104f5366004614c2b565b6136ef565b6102d5610508366004614fb2565b61371a565b6102e0600081565b61051d613a0e565b60405161ffff90911681526020016102b9565b6102d561053e366004614c12565b613a4a565b6102e0610551366004614d92565b613cb0565b610569610564366004614bdb565b613d80565b6040516102b9929190614fcf565b60cc5461058a906001600160a01b031681565b6040516001600160a01b0390911681526020016102b9565b60cd5461058a906001600160a01b031681565b6105c86105c3366004614d92565b613ef1565b6040516102b99190614ffd565b6102e060cf5481565b6102d56105ec366004614eff565b613f8e565b6102d56105ff366004614c2b565b614022565b610483610612366004614d92565b614048565b6102e0610625366004614d92565b6140a1565b6102e060ce5481565b610646610641366004614d92565b61413a565b6040516102b99493929190615044565b6102d5610664366004614d92565b61426a565b6102d5610677366004614d92565b6142b3565b6102e060d35481565b60006001600160e01b03198216637965db0b60e01b14806106b657506301ffc9a760e01b6001600160e01b03198316145b92915050565b60975460ff16156106e85760405162461bcd60e51b81526004016106df90615073565b60405180910390fd5b333b156107075760405162461bcd60e51b81526004016106df9061509d565b60d1546001600160a01b031633146107315760405162461bcd60e51b81526004016106df906150d2565b60ff811615806107545750600a8160ff16101580156107545750601d8160ff1611155b6107705760405162461bcd60e51b81526004016106df9061511a565b826000036107b05760405162461bcd60e51b815260206004820152600d60248201526c0565449207072696365203d203609c1b60448201526064016106df565b6000836107c586670de0b6b3a7640000615167565b6107cf9190615194565b60cc546040516370a0823160e01b815230600482015291925082916001600160a01b03909116906370a0823190602401602060405180830381865afa15801561081c573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061084091906151a8565b101561085e5760405162461bcd60e51b81526004016106df906151c1565b8060ce5410156108aa5760405162461bcd60e51b815260206004820152601760248201527656544920616d6f756e74203e2056544942616c616e636560481b60448201526064016106df565b60cd5460d0546040516370a0823160e01b81526001600160a01b039182166004820152879291909116906370a0823190602401602060405180830381865afa1580156108fa573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061091e91906151a8565b101561096c5760405162461bcd60e51b815260206004820181905260248201527f4e6f7420656e6f7567682055534454206f6e2073797374656d2077616c6c657460448201526064016106df565b60cd546040516370a0823160e01b81523060048201526000916001600160a01b0316906370a0823190602401602060405180830381865afa1580156109b5573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109d991906151a8565b60cd5460d0546040516323b872dd60e01b81529293506001600160a01b03918216926323b872dd92610a1392169030908b90600401615202565b6020604051808303816000875af1158015610a32573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a569190615226565b5060cd546040516370a0823160e01b8152306004820152879183916001600160a01b03909116906370a0823190602401602060405180830381865afa158015610aa3573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610ac791906151a8565b610ad19190615248565b14610aee5760405162461bcd60e51b81526004016106df9061525b565b8560d46000828254610b009190615287565b909155505060ff8316600003610d465760cc5460405163a9059cbb60e01b81526001600160a01b038681166004830152602482018590529091169063a9059cbb906044016020604051808303816000875af1158015610b63573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b879190615226565b506001600160a01b038416600090815260ca60205260408120600901549003610bce576001600160a01b038416600090815260ca6020526040902042600990910155610c90565b60c9546001600160a01b038516600090815260ca6020526040902060090154640757b12c009162010000900461ffff1690610c099042615248565b6001600160a01b038716600090815260ca6020526040902054610c2c9190615167565b610c369190615167565b610c409190615194565b6001600160a01b038516600090815260ca602052604081206007018054909190610c6b908490615287565b90915550506001600160a01b038416600090815260ca60205260409020426009909101555b6001600160a01b038416600090815260ca602052604081208054849290610cb8908490615287565b90915550506001600160a01b038416600090815260ca602052604081206002018054889290610ce8908490615287565b90915550506001600160a01b038416600090815260ca602052604090208054600290910154610d1f90670de0b6b3a7640000615167565b610d299190615194565b6001600160a01b038516600090815260ca60205260409020600101555b600a8360ff1610158015610d5e5750601d8360ff1611155b15610e545760cc5460d25460405163a9059cbb60e01b81526001600160a01b0391821660048201526024810185905291169063a9059cbb906044016020604051808303816000875af1158015610db8573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610ddc9190615226565b5060d254604051635ff6170d60e11b815260048101889052602481018490526001600160a01b03868116604483015260ff861660648301529091169063bfec2e1a90608401600060405180830381600087803b158015610e3b57600080fd5b505af1158015610e4f573d6000803e3d6000fd5b505050505b8560cf6000828254610e669190615287565b925050819055508160ce6000828254610e7f9190615248565b90915550610e8d9050614b07565b6000815260ff84166020820152610ea3426142fc565b6040808301918252606083018590526080830188905260a083018990526001600160a01b038716600090815260cb602090815291812080546001818101835591835291839020855160059093020180549386015160ff9081166101000261ffff199095169316929092179290921781559151839291820190610f259082615322565b50606082015181600201556080820151816003015560a08201518160040155505050505050505050565b6000610f5d60975460ff1690565b15610f7a5760405162461bcd60e51b81526004016106df90615073565b600a8260ff1610158015610f925750601d8260ff1611155b610fae5760405162461bcd60e51b81526004016106df9061511a565b60d254604051638cce24ed60e01b81526001600160a01b0390911690638cce24ed90610fe090869086906004016153e2565b602060405180830381865afa158015610ffd573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906110219190615226565b61103d5760405162461bcd60e51b81526004016106df906153fe565b60d254604051633ed0d8f960e01b81526001600160a01b0390911690633ed0d8f99061106f90869086906004016153e2565b602060405180830381865afa15801561108c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906110b091906151a8565b9392505050565b6000828152606560205260409020600101546110d381336144ba565b6110dd838361451e565b505050565b60975460ff16156111055760405162461bcd60e51b81526004016106df90615073565b333b156111245760405162461bcd60e51b81526004016106df9061509d565b60018360ff16111561116d5760405162461bcd60e51b815260206004820152601260248201527157726f6e672070726f6772616d207479706560701b60448201526064016106df565b8260ff166000036111e35760d25460405163f368440560e01b81526001600160a01b039091169063f3684405906111ac90339086908690600401615429565b600060405180830381600087803b1580156111c657600080fd5b505af11580156111da573d6000803e3d6000fd5b50505050505050565b60d25460405163aebd903f60e01b81526001600160a01b039091169063aebd903f906111ac90339086908690600401615429565b6001600160a01b03811633146112875760405162461bcd60e51b815260206004820152602f60248201527f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560448201526e103937b632b9903337b91039b2b63360891b60648201526084016106df565b61129182826145a4565b5050565b6000806112a460975460ff1690565b156112c15760405162461bcd60e51b81526004016106df90615073565b60c95433600090815260ca6020526040902060090154640757b12c009162010000900461ffff16906112f39042615248565b33600090815260ca602052604090205461130d9190615167565b6113179190615167565b6113219190615194565b6001600160a01b038416600090815260ca60205260409020600701546113479190615287565b6001600160a01b0393909316600090815260ca60205260409020600801549293915050565b6113776000336136ef565b6113935760405162461bcd60e51b81526004016106df9061545f565b60cd80546001600160a01b0319166001600160a01b0392909216919091179055565b60975460ff16156113d85760405162461bcd60e51b81526004016106df90615073565b333b156113f75760405162461bcd60e51b81526004016106df9061509d565b60d1546001600160a01b031633146114215760405162461bcd60e51b81526004016106df906150d2565b60c95442906114349061ffff1685615287565b10156114525760405162461bcd60e51b81526004016106df90615496565b818611156114a25760405162461bcd60e51b815260206004820152601e60248201527f5553445420616d6f756e742065786365656473206f70656e206c696d6974000060448201526064016106df565b60ff811615806114c55750600a8160ff16101580156114c55750601d8160ff1611155b6114e15760405162461bcd60e51b81526004016106df9061511a565b6000856114f688670de0b6b3a7640000615167565b6115009190615194565b60cc546040516370a0823160e01b815230600482015291925082916001600160a01b03909116906370a0823190602401602060405180830381865afa15801561154d573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061157191906151a8565b101561158f5760405162461bcd60e51b81526004016106df906151c1565b60cd546040516370a0823160e01b81523060048201526000916001600160a01b0316906370a0823190602401602060405180830381865afa1580156115d8573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906115fc91906151a8565b60cd546040516323b872dd60e01b81529192506001600160a01b0316906323b872dd9061163190899030908d90600401615202565b6020604051808303816000875af1158015611650573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906116749190615226565b5060cd546040516370a0823160e01b8152306004820152899183916001600160a01b03909116906370a0823190602401602060405180830381865afa1580156116c1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906116e591906151a8565b6116ef9190615248565b1461170c5760405162461bcd60e51b81526004016106df9061525b565b8260ff1660000361194d5760cc5460405163a9059cbb60e01b81526001600160a01b038881166004830152602482018590529091169063a9059cbb906044016020604051808303816000875af115801561176a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061178e9190615226565b506001600160a01b038616600090815260ca602052604081206009015490036117d5576001600160a01b038616600090815260ca6020526040902042600990910155611897565b60c9546001600160a01b038716600090815260ca6020526040902060090154640757b12c009162010000900461ffff16906118109042615248565b6001600160a01b038916600090815260ca60205260409020546118339190615167565b61183d9190615167565b6118479190615194565b6001600160a01b038716600090815260ca602052604081206007018054909190611872908490615287565b90915550506001600160a01b038616600090815260ca60205260409020426009909101555b6001600160a01b038616600090815260ca6020526040812080548492906118bf908490615287565b90915550506001600160a01b038616600090815260ca6020526040812060020180548a92906118ef908490615287565b90915550506001600160a01b038616600090815260ca60205260409020805460029091015461192690670de0b6b3a7640000615167565b6119309190615194565b6001600160a01b038716600090815260ca60205260409020600101555b600a8360ff16101580156119655750601d8360ff1611155b15611a5b5760cc5460d25460405163a9059cbb60e01b81526001600160a01b0391821660048201526024810185905291169063a9059cbb906044016020604051808303816000875af11580156119bf573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906119e39190615226565b5060d254604051635ff6170d60e11b8152600481018a9052602481018490526001600160a01b03888116604483015260ff861660648301529091169063bfec2e1a90608401600060405180830381600087803b158015611a4257600080fd5b505af1158015611a56573d6000803e3d6000fd5b505050505b8760cf6000828254611a6d9190615287565b925050819055508160ce6000828254611a869190615248565b90915550611a949050614b07565b6000815260ff84166020820152611aaa426142fc565b604080830191825260608301859052608083018a905260a083018b90526001600160a01b038916600090815260cb602090815291812080546001818101835591835291839020855160059093020180549386015160ff9081166101000261ffff199095169316929092179290921781559151839291820190611b2c9082615322565b50606082015181600201556080820151816003015560a082015181600401555050505050505050505050565b611b636000336136ef565b611b7f5760405162461bcd60e51b81526004016106df9061545f565b611b8761460b565b565b611b946000336136ef565b611bb05760405162461bcd60e51b81526004016106df9061545f565b60d180546001600160a01b0319166001600160a01b0392909216919091179055565b6060611be060975460ff1690565b15611bfd5760405162461bcd60e51b81526004016106df90615073565b6001600160a01b038216600090815260cb6020908152604080832080548251818502810185019093528083529193909284015b82821015611d305760008481526020908190206040805160c08101825260058602909201805460ff8082168552610100909104169383019390935260018301805492939291840191611c819061529a565b80601f0160208091040260200160405190810160405280929190818152602001828054611cad9061529a565b8015611cfa5780601f10611ccf57610100808354040283529160200191611cfa565b820191906000526020600020905b815481529060010190602001808311611cdd57829003601f168201915b50505050508152602001600282015481526020016003820154815260200160048201548152505081526020019060010190611c30565b5050505090505b919050565b611d476000336136ef565b611d635760405162461bcd60e51b81526004016106df9061545f565b60cd546040516370a0823160e01b815230600482015282916001600160a01b0316906370a0823190602401602060405180830381865afa158015611dab573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611dcf91906151a8565b1015611ded5760405162461bcd60e51b81526004016106df906154de565b8060cf541015611e3f5760405162461bcd60e51b815260206004820152601960248201527f5553445420616d6f756e74203e205553445442616c616e63650000000000000060448201526064016106df565b60cd5460405163a9059cbb60e01b8152336004820152602481018390526001600160a01b039091169063a9059cbb906044016020604051808303816000875af1158015611e90573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611eb49190615226565b508060cf6000828254611ec79190615248565b909155505050565b611eda6000336136ef565b611ef65760405162461bcd60e51b81526004016106df9061545f565b60c9805461ffff191661ffff92909216919091179055565b611f196000336136ef565b611f355760405162461bcd60e51b81526004016106df9061545f565b60cc80546001600160a01b0319166001600160a01b0392909216919091179055565b60975460ff1615611f7a5760405162461bcd60e51b81526004016106df90615073565b60cc546040516370a0823160e01b81523360048201526001600160a01b03909116906370a0823190602401602060405180830381865afa158015611fc2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611fe691906151a8565b81111561202d5760405162461bcd60e51b8152602060048201526015602482015274139bdd08195b9bdd59da08159512481d1bc8185919605a1b60448201526064016106df565b60cc546040516370a0823160e01b81523060048201526000916001600160a01b0316906370a0823190602401602060405180830381865afa158015612076573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061209a91906151a8565b60cc546040516323b872dd60e01b81529192506001600160a01b0316906323b872dd906120cf90339030908790600401615202565b6020604051808303816000875af11580156120ee573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906121129190615226565b5060cc546040516370a0823160e01b8152306004820152839183916001600160a01b03909116906370a0823190602401602060405180830381865afa15801561215f573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061218391906151a8565b61218d9190615248565b146121ce5760405162461bcd60e51b81526020600482015260116024820152702b2a24902830bcb6b2b73a1032b93937b960791b60448201526064016106df565b8160ce60008282546121e09190615287565b90915550505050565b60606121f760975460ff1690565b156122145760405162461bcd60e51b81526004016106df90615073565b60d2546040516362f75b5960e11b81526001600160a01b038481166004830152600092169063c5eeb6b290602401600060405180830381865afa15801561225f573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526122879190810190615515565b90506000815167ffffffffffffffff8111156122a5576122a5614c57565b6040519080825280602002602001820160405280156122ea57816020015b60408051808201909152600080825260208201528152602001906001900390816122c35790505b50905060005b82518110156123925782818151811061230b5761230b6155c7565b6020026020010151828281518110612325576123256155c7565b60200260200101516000019060ff16908160ff168152505061236085848381518110612353576123536155c7565b6020026020010151610f4f565b828281518110612372576123726155c7565b60209081029190910181015101528061238a816155dd565b9150506122f0565b509392505050565b6123a56000336136ef565b6123c15760405162461bcd60e51b81526004016106df9061545f565b6103e88161ffff16111561240b5760405162461bcd60e51b815260206004820152601160248201527077726f6e6720737563636573732066656560781b60448201526064016106df565b60c9805461ffff9092166401000000000265ffff0000000019909216919091179055565b600080600061244060975460ff1690565b1561245d5760405162461bcd60e51b81526004016106df90615073565b600a8460ff16101580156124755750601d8460ff1611155b6124915760405162461bcd60e51b81526004016106df9061511a565b60d254604051638cce24ed60e01b81526001600160a01b0390911690638cce24ed906124c390889088906004016153e2565b602060405180830381865afa1580156124e0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906125049190615226565b6125205760405162461bcd60e51b81526004016106df906153fe565b60d254604051630bbfb2a760e11b81526001600160a01b039091169063177f654e9061255290889088906004016153e2565b606060405180830381865afa15801561256f573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061259391906155f6565b9250925092509250925092565b60006125ae60975460ff1690565b156125cb5760405162461bcd60e51b81526004016106df90615073565b333b156125ea5760405162461bcd60e51b81526004016106df9061509d565b60d1546001600160a01b031633146126145760405162461bcd60e51b81526004016106df906150d2565b60c95442906126279061ffff1684615287565b10156126455760405162461bcd60e51b81526004016106df90615496565b60c9546001600160a01b038416600090815260ca6020526040902060090154640757b12c009162010000900461ffff16906126809042615248565b6001600160a01b038616600090815260ca60205260409020546126a39190615167565b6126ad9190615167565b6126b79190615194565b6001600160a01b038416600090815260ca6020526040812060070180549091906126e2908490615287565b90915550506001600160a01b038316600090815260ca60205260409020426009820155600881015460079091015461271a9190615248565b851161275c5760405162461bcd60e51b81526020600482015260116024820152701b519959480f8815951248185b5bdd5b9d607a1b60448201526064016106df565b6001600160a01b038316600090815260ca6020526040812060088101546007909101546127899190615248565b6127939087615248565b6001600160a01b038516600090815260ca602052604081206007810154600890910155909150670de0b6b3a76400006127cc8784615167565b6127d69190615194565b60cd546040516370a0823160e01b815230600482015291925082916001600160a01b03909116906370a0823190602401602060405180830381865afa158015612823573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061284791906151a8565b10156128655760405162461bcd60e51b81526004016106df906154de565b60cc546040516370a0823160e01b81523060048201526000916001600160a01b0316906370a0823190602401602060405180830381865afa1580156128ae573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906128d291906151a8565b60cc546040516323b872dd60e01b81529192506001600160a01b0316906323b872dd9061290790899030908890600401615202565b6020604051808303816000875af1158015612926573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061294a9190615226565b5060cc546040516370a0823160e01b8152306004820152849183916001600160a01b03909116906370a0823190602401602060405180830381865afa158015612997573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906129bb91906151a8565b6129c59190615248565b146129e25760405162461bcd60e51b81526004016106df9061525b565b60cc5460d0546001600160a01b03918216916323b872dd91899116612a07878d615248565b6040518463ffffffff1660e01b8152600401612a2593929190615202565b6020604051808303816000875af1158015612a44573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612a689190615226565b5060cd5460d05460405163a9059cbb60e01b81526001600160a01b0391821660048201526024810185905291169063a9059cbb906044016020604051808303816000875af1158015612abe573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612ae29190615226565b508160d36000828254612af59190615287565b925050819055508160cf6000828254612b0e9190615248565b925050819055508260ce6000828254612b279190615287565b90915550506001600160a01b038616600090815260ca6020526040812060030180548a9290612b57908490615287565b90915550506001600160a01b038616600090815260ca602052604081206005018054849290612b87908490615287565b90915550506001600160a01b038616600090815260ca602052604090206003810154600590910154612bc190670de0b6b3a7640000615167565b612bcb9190615194565b6001600160a01b038716600090815260ca602052604090206004810182905560010154670de0b6b3a764000091612c029190615624565b6001600160a01b038816600090815260ca6020526040902060030154612c28919061564b565b612c32919061567b565b6001600160a01b038716600090815260ca6020526040902060060155612c56614b07565b6001815260006020820152612c6a426142fc565b6040808301918252606083018b9052608083018a905260a083018590526001600160a01b038916600090815260cb602090815291812080546001818101835591835291839020855160059093020180549386015160ff9081166101000261ffff199095169316929092179290921781559151839291820190612cec9082615322565b50606082015160028201556080820151600382015560a0909101516004909101555090979650505050505050565b612d256000336136ef565b612d415760405162461bcd60e51b81526004016106df9061545f565b60cc546040516370a0823160e01b815230600482015282916001600160a01b0316906370a0823190602401602060405180830381865afa158015612d89573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612dad91906151a8565b1015612dfb5760405162461bcd60e51b815260206004820152601a60248201527f4e6f7420656e6f75676820565449206f6e20636f6e747261637400000000000060448201526064016106df565b8060ce541015612e475760405162461bcd60e51b815260206004820152601760248201527656544920616d6f756e74203e2056544942616c616e636560481b60448201526064016106df565b60cc5460405163a9059cbb60e01b8152336004820152602481018390526001600160a01b039091169063a9059cbb906044016020604051808303816000875af1158015612e98573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612ebc9190615226565b508060ce6000828254611ec79190615248565b600054610100900460ff1680612ee8575060005460ff16155b612f045760405162461bcd60e51b81526004016106df906156a9565b600054610100900460ff16158015612f26576000805461ffff19166101011790555b612f2e61469e565b612f36614721565b612f41600033614796565b60c9805465ffffffffffff191664c8001400b41790558015612f69576000805461ff00191690555b50565b612f776000336136ef565b612f935760405162461bcd60e51b81526004016106df9061545f565b611b876147a0565b60975460ff1615612fbe5760405162461bcd60e51b81526004016106df90615073565b333b15612fdd5760405162461bcd60e51b81526004016106df9061509d565b60d1546001600160a01b031633146130075760405162461bcd60e51b81526004016106df906150d2565b60c954429061301a9061ffff1683615287565b10156130385760405162461bcd60e51b81526004016106df90615496565b60c9546001600160a01b038316600090815260ca6020526040902060090154640757b12c009162010000900461ffff16906130739042615248565b6001600160a01b038516600090815260ca60205260409020546130969190615167565b6130a09190615167565b6130aa9190615194565b6001600160a01b038316600090815260ca6020526040812060070180549091906130d5908490615287565b90915550506001600160a01b038216600090815260ca60205260409020426009820155600881015460079091015461310d9190615248565b841161314f5760405162461bcd60e51b81526020600482015260116024820152701b519959480f8815951248185b5bdd5b9d607a1b60448201526064016106df565b6001600160a01b038216600090815260ca60205260408120600881015460079091015461317c9190615248565b6131869086615248565b6001600160a01b038416600090815260ca602052604081206007810154600890910155909150670de0b6b3a76400006131bf8684615167565b6131c99190615194565b60cd546040516370a0823160e01b815230600482015291925082916001600160a01b03909116906370a0823190602401602060405180830381865afa158015613216573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061323a91906151a8565b10156132585760405162461bcd60e51b81526004016106df906154de565b60cc546040516370a0823160e01b81523060048201526000916001600160a01b0316906370a0823190602401602060405180830381865afa1580156132a1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906132c591906151a8565b60cc546040516323b872dd60e01b81529192506001600160a01b0316906323b872dd906132fa90889030908890600401615202565b6020604051808303816000875af1158015613319573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061333d9190615226565b5060cc546040516370a0823160e01b8152306004820152849183916001600160a01b03909116906370a0823190602401602060405180830381865afa15801561338a573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906133ae91906151a8565b6133b89190615248565b146133d55760405162461bcd60e51b81526004016106df9061525b565b60cc5460d0546001600160a01b03918216916323b872dd918891166133fa878c615248565b6040518463ffffffff1660e01b815260040161341893929190615202565b6020604051808303816000875af1158015613437573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061345b9190615226565b5060cd5460405163a9059cbb60e01b81526001600160a01b038781166004830152602482018590529091169063a9059cbb906044016020604051808303816000875af11580156134af573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906134d39190615226565b508160cf60008282546134e69190615248565b925050819055508660ce60008282546134ff9190615287565b90915550506001600160a01b038516600090815260ca60205260408120600301805489929061352f908490615287565b90915550506001600160a01b038516600090815260ca60205260408120600501805484929061355f908490615287565b90915550506001600160a01b038516600090815260ca60205260409020600381015460059091015461359990670de0b6b3a7640000615167565b6135a39190615194565b6001600160a01b038616600090815260ca602052604090206004810182905560010154670de0b6b3a7640000916135da9190615624565b6001600160a01b038716600090815260ca6020526040902060030154613600919061564b565b61360a919061567b565b6001600160a01b038616600090815260ca602052604090206006015561362e614b07565b6001815260006020820152613642426142fc565b6040808301918252606083018a90526080830189905260a083018590526001600160a01b038816600090815260cb602090815291812080546001818101835591835291839020855160059093020180549386015160ff9081166101000261ffff1990951693169290921792909217815591518392918201906136c49082615322565b50606082015181600201556080820151816003015560a0820151816004015550505050505050505050565b60009182526065602090815260408084206001600160a01b0393909316845291905290205460ff1690565b60975460ff161561373d5760405162461bcd60e51b81526004016106df90615073565b333b1561375c5760405162461bcd60e51b81526004016106df9061509d565b600a8160ff16101580156137745750601d8160ff1611155b6137905760405162461bcd60e51b81526004016106df9061511a565b60d254604051630c2bf51760e21b8152600091829182916001600160a01b0316906330afd45c906137c790339088906004016153e2565b6060604051808303816000875af11580156137e6573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061380a91906155f6565b60c95433600090815260ca60205260409020600901549396509194509250640757b12c00916201000090910461ffff16906138459042615248565b33600090815260ca602052604090205461385f9190615167565b6138699190615167565b6138739190615194565b33600090815260ca602052604081206007018054909190613895908490615287565b909155505033600090815260ca6020526040812042600982015580548592906138bf908490615287565b909155505033600090815260ca6020526040812060020180548492906138e6908490615287565b909155505033600090815260ca60205260409020805460029091015461391490670de0b6b3a7640000615167565b61391e9190615194565b33600090815260ca6020526040812060018101929092556007909101805483929061394a908490615287565b909155506139589050614b07565b6002815260ff8516602082015261396e426142fc565b60408083019182526060830186905260006080840181905260a0840186905233815260cb602090815291812080546001818101835591835291839020855160059093020180549386015160ff9081166101000261ffff1990951693169290921792909217815591518392918201906139e69082615322565b50606082015181600201556080820151816003015560a0820151816004015550505050505050565b6000613a1c60975460ff1690565b15613a395760405162461bcd60e51b81526004016106df90615073565b5060c95462010000900461ffff1690565b60975460ff1615613a6d5760405162461bcd60e51b81526004016106df90615073565b60cd546040516370a0823160e01b81523360048201526001600160a01b03909116906370a0823190602401602060405180830381865afa158015613ab5573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613ad991906151a8565b811115613b215760405162461bcd60e51b8152602060048201526016602482015275139bdd08195b9bdd59da081554d115081d1bc818591960521b60448201526064016106df565b60cd546040516370a0823160e01b81523060048201526000916001600160a01b0316906370a0823190602401602060405180830381865afa158015613b6a573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613b8e91906151a8565b60cd546040516323b872dd60e01b81529192506001600160a01b0316906323b872dd90613bc390339030908790600401615202565b6020604051808303816000875af1158015613be2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613c069190615226565b5060cd546040516370a0823160e01b8152306004820152839183916001600160a01b03909116906370a0823190602401602060405180830381865afa158015613c53573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613c7791906151a8565b613c819190615248565b14613c9e5760405162461bcd60e51b81526004016106df9061525b565b8160cf60008282546121e09190615287565b6000613cbe60975460ff1690565b15613cdb5760405162461bcd60e51b81526004016106df90615073565b6001600160a01b038216600090815260ca60205260408082206008015460c9543384529190922060090154640757b12c009162010000900461ffff1690613d229042615248565b33600090815260ca6020526040902054613d3c9190615167565b613d469190615167565b613d509190615194565b6001600160a01b038416600090815260ca6020526040902060070154613d769190615287565b6106b69190615248565b606080613d8f60975460ff1690565b15613dac5760405162461bcd60e51b81526004016106df90615073565b600a8360ff1610158015613dc45750601d8360ff1611155b613de05760405162461bcd60e51b81526004016106df9061511a565b60d254604051638cce24ed60e01b81526001600160a01b0390911690638cce24ed90613e1290879087906004016153e2565b602060405180830381865afa158015613e2f573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613e539190615226565b613e6f5760405162461bcd60e51b81526004016106df906153fe565b60d254604051630f8867e560e31b81526001600160a01b0390911690637c433f2890613ea190879087906004016153e2565b600060405180830381865afa158015613ebe573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052613ee6919081019061573c565b915091509250929050565b6060613eff60975460ff1690565b15613f1c5760405162461bcd60e51b81526004016106df90615073565b60d2546040516362f75b5960e11b81526001600160a01b0384811660048301529091169063c5eeb6b290602401600060405180830381865afa158015613f66573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526106b69190810190615515565b613f996000336136ef565b613fb55760405162461bcd60e51b81526004016106df9061545f565b6103e88161ffff1611156140025760405162461bcd60e51b815260206004820152601460248201527377726f6e67206d616974616e616e63652066656560601b60448201526064016106df565b60c9805461ffff909216620100000263ffff000019909216919091179055565b60008281526065602052604090206001015461403e81336144ba565b6110dd83836145a4565b600080600061405960975460ff1690565b156140765760405162461bcd60e51b81526004016106df90615073565b5050506001600160a01b0316600090815260ca60205260409020805460018201546002909201549092565b60006140af60975460ff1690565b156140cc5760405162461bcd60e51b81526004016106df90615073565b60cc546040516370a0823160e01b81526001600160a01b038481166004830152909116906370a0823190602401602060405180830381865afa158015614116573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106b691906151a8565b6000806000606061414d60975460ff1690565b1561416a5760405162461bcd60e51b81526004016106df90615073565b6001600160a01b038516600090815260ca602052604081206006015460609082136141dc576001600160a01b038716600090815260ca602052604090206006015491506141b6826147f8565b6040516020016141c691906157a0565b6040516020818303038152906040529050614231565b6001600160a01b038716600090815260ca60205260409020600601546142049060001961564b565b915061420f826147f8565b60405160200161421f91906157bc565b60405160208183030381529060405290505b6001600160a01b0396909616600090815260ca602052604090206003810154600482015460059092015490989197909650945092505050565b6142756000336136ef565b6142915760405162461bcd60e51b81526004016106df9061545f565b60d080546001600160a01b0319166001600160a01b0392909216919091179055565b6142be6000336136ef565b6142da5760405162461bcd60e51b81526004016106df9061545f565b60d280546001600160a01b0319166001600160a01b0392909216919091179055565b6060600061430d6201518084615194565b9050600061431e8262010bd96157e5565b61432b9062253d8c6157e5565b9050600062023ab161433e83600461564b565b614348919061567b565b905060046143598262023ab161564b565b6143649060036157e5565b61436e919061567b565b6143789083615624565b9150600062164b0961438b8460016157e5565b61439790610fa061564b565b6143a1919061567b565b905060046143b1826105b561564b565b6143bb919061567b565b6143c59084615624565b6143d090601f6157e5565b9250600061098f6143e285605061564b565b6143ec919061567b565b9050600060506143fe8361098f61564b565b614408919061567b565b6144129086615624565b905061441f600b8361567b565b945061442c85600c61564b565b6144378360026157e5565b6144419190615624565b91508483614450603187615624565b61445b90606461564b565b61446591906157e5565b61446f91906157e5565b925061447a816147f8565b614483836147f8565b61448c856147f8565b60405160200161449e9392919061580d565b6040516020818303038152906040529650505050505050919050565b6144c482826136ef565b611291576144dc816001600160a01b03166014614901565b6144e7836020614901565b6040516020016144f8929190615867565b60408051601f198184030181529082905262461bcd60e51b82526106df916004016158dc565b61452882826136ef565b6112915760008281526065602090815260408083206001600160a01b03851684529091529020805460ff191660011790556145603390565b6001600160a01b0316816001600160a01b0316837f2f8788117e7eff1d82e926ec794901d17c78024a50270940304540a733656f0d60405160405180910390a45050565b6145ae82826136ef565b156112915760008281526065602090815260408083206001600160a01b0385168085529252808320805460ff1916905551339285917ff6391f5c32d9c69d2a47ea670b442974b53935d1edc7fd64eb21e047a839171b9190a45050565b60975460ff166146545760405162461bcd60e51b815260206004820152601460248201527314185d5cd8589b194e881b9bdd081c185d5cd95960621b60448201526064016106df565b6097805460ff191690557f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa335b6040516001600160a01b03909116815260200160405180910390a1565b600054610100900460ff16806146b7575060005460ff16155b6146d35760405162461bcd60e51b81526004016106df906156a9565b600054610100900460ff161580156146f5576000805461ffff19166101011790555b6146fd614a9d565b614705614a9d565b61470d614a9d565b8015612f69576000805461ff001916905550565b600054610100900460ff168061473a575060005460ff16155b6147565760405162461bcd60e51b81526004016106df906156a9565b600054610100900460ff16158015614778576000805461ffff19166101011790555b6097805460ff191690558015612f69576000805461ff001916905550565b611291828261451e565b60975460ff16156147c35760405162461bcd60e51b81526004016106df90615073565b6097805460ff191660011790557f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a2586146813390565b60608160000361481f5750506040805180820190915260018152600360fc1b602082015290565b8160005b81156148495780614833816155dd565b91506148429050600a83615194565b9150614823565b60008167ffffffffffffffff81111561486457614864614c57565b6040519080825280601f01601f19166020018201604052801561488e576020820181803683370190505b5090505b84156148f9576148a3600183615248565b91506148b0600a866158ef565b6148bb906030615287565b60f81b8183815181106148d0576148d06155c7565b60200101906001600160f81b031916908160001a9053506148f2600a86615194565b9450614892565b949350505050565b60606000614910836002615167565b61491b906002615287565b67ffffffffffffffff81111561493357614933614c57565b6040519080825280601f01601f19166020018201604052801561495d576020820181803683370190505b509050600360fc1b81600081518110614978576149786155c7565b60200101906001600160f81b031916908160001a905350600f60fb1b816001815181106149a7576149a76155c7565b60200101906001600160f81b031916908160001a90535060006149cb846002615167565b6149d6906001615287565b90505b6001811115614a4e576f181899199a1a9b1b9c1cb0b131b232b360811b85600f1660108110614a0a57614a0a6155c7565b1a60f81b828281518110614a2057614a206155c7565b60200101906001600160f81b031916908160001a90535060049490941c93614a4781615903565b90506149d9565b5083156110b05760405162461bcd60e51b815260206004820181905260248201527f537472696e67733a20686578206c656e67746820696e73756666696369656e7460448201526064016106df565b600054610100900460ff1680614ab6575060005460ff16155b614ad25760405162461bcd60e51b81526004016106df906156a9565b600054610100900460ff1615801561470d576000805461ffff19166101011790558015612f69576000805461ff001916905550565b6040518060c00160405280600060ff168152602001600060ff168152602001606081526020016000815260200160008152602001600081525090565b600060208284031215614b5557600080fd5b81356001600160e01b0319811681146110b057600080fd5b80356001600160a01b0381168114611d3757600080fd5b60ff81168114612f6957600080fd5b60008060008060808587031215614ba957600080fd5b8435935060208501359250614bc060408601614b6d565b91506060850135614bd081614b84565b939692955090935050565b60008060408385031215614bee57600080fd5b614bf783614b6d565b91506020830135614c0781614b84565b809150509250929050565b600060208284031215614c2457600080fd5b5035919050565b60008060408385031215614c3e57600080fd5b82359150614c4e60208401614b6d565b90509250929050565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff81118282101715614c9657614c96614c57565b604052919050565b600067ffffffffffffffff821115614cb857614cb8614c57565b50601f01601f191660200190565b600082601f830112614cd757600080fd5b8135614cea614ce582614c9e565b614c6d565b818152846020838601011115614cff57600080fd5b816020850160208301376000918101602001919091529392505050565b600080600060608486031215614d3157600080fd5b8335614d3c81614b84565b9250602084013567ffffffffffffffff80821115614d5957600080fd5b614d6587838801614cc6565b93506040860135915080821115614d7b57600080fd5b50614d8886828701614cc6565b9150509250925092565b600060208284031215614da457600080fd5b6110b082614b6d565b60008060008060008060c08789031215614dc657600080fd5b8635955060208701359450614ddd60408801614b6d565b9350606087013592506080870135915060a0870135614dfb81614b84565b809150509295509295509295565b60005b83811015614e24578181015183820152602001614e0c565b50506000910152565b60008151808452614e45816020860160208601614e09565b601f01601f19169290920160200192915050565b60006020808301818452808551808352604092508286019150828160051b87010184880160005b83811015614ef157603f19898403018552815160c060ff808351168652808a840151168a87015250878201518189870152614ebd82870182614e2d565b606084810151908801526080808501519088015260a093840151939096019290925250509386019390860190600101614e80565b509098975050505050505050565b600060208284031215614f1157600080fd5b813561ffff811681146110b057600080fd5b602080825282518282018190526000919060409081850190868401855b82811015614f68578151805160ff168552860151868501529284019290850190600101614f40565b5091979650505050505050565b60008060008060808587031215614f8b57600080fd5b8435935060208501359250614fa260408601614b6d565b9396929550929360600135925050565b600060208284031215614fc457600080fd5b81356110b081614b84565b604081526000614fe26040830185614e2d565b8281036020840152614ff48185614e2d565b95945050505050565b6020808252825182820181905260009190848201906040850190845b8181101561503857835160ff1683529284019291840191600101615019565b50909695505050505050565b8481528360208201528260408201526080606082015260006150696080830184614e2d565b9695505050505050565b60208082526010908201526f14185d5cd8589b194e881c185d5cd95960821b604082015260600190565b6020808252818101527f436f6e74726163742063616c6c7320617265206e6f7420617661696c61626c65604082015260600190565b60208082526028908201527f4f6e6c79206261636b20616464726573732063616e2063616c6c207468697320604082015267333ab731ba34b7b760c11b606082015260800190565b6020808252601c908201527f4465706f7369742074797065206973206f7574206f662072616e676500000000604082015260600190565b634e487b7160e01b600052601160045260246000fd5b80820281158282048414176106b6576106b6615151565b634e487b7160e01b600052601260045260246000fd5b6000826151a3576151a361517e565b500490565b6000602082840312156151ba57600080fd5b5051919050565b60208082526021908201527f4e6f7420656e6f7567682056544920746f6b656e73206f6e20636f6e747261636040820152601d60fa1b606082015260800190565b6001600160a01b039384168152919092166020820152604081019190915260600190565b60006020828403121561523857600080fd5b815180151581146110b057600080fd5b818103818111156106b6576106b6615151565b6020808252601290820152712aa9a22a102830bcb6b2b73a1032b93937b960711b604082015260600190565b808201808211156106b6576106b6615151565b600181811c908216806152ae57607f821691505b6020821081036152ce57634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156110dd57600081815260208120601f850160051c810160208610156152fb5750805b601f850160051c820191505b8181101561531a57828155600101615307565b505050505050565b815167ffffffffffffffff81111561533c5761533c614c57565b6153508161534a845461529a565b846152d4565b602080601f831160018114615385576000841561536d5750858301515b600019600386901b1c1916600185901b17855561531a565b600085815260208120601f198616915b828110156153b457888601518255948401946001909101908401615395565b50858210156153d25787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b6001600160a01b0392909216825260ff16602082015260400190565b6020808252601190820152704e6f207375636820612070726f6772616d60781b604082015260600190565b6001600160a01b038416815260606020820181905260009061544d90830185614e2d565b82810360408401526150698185614e2d565b60208082526017908201527f43616c6c6572206973206e6f74207468652041646d696e000000000000000000604082015260600190565b60208082526028908201527f54696d6520666f72207369676e696e67207472616e73616374696f6e2068617360408201526708195e1c1a5c995960c21b606082015260800190565b6020808252601b908201527f4e6f7420656e6f7567682055534454206f6e20636f6e74726163740000000000604082015260600190565b6000602080838503121561552857600080fd5b825167ffffffffffffffff8082111561554057600080fd5b818501915085601f83011261555457600080fd5b81518181111561556657615566614c57565b8060051b9150615577848301614c6d565b818152918301840191848101908884111561559157600080fd5b938501935b838510156155bb57845192506155ab83614b84565b8282529385019390850190615596565b98975050505050505050565b634e487b7160e01b600052603260045260246000fd5b6000600182016155ef576155ef615151565b5060010190565b60008060006060848603121561560b57600080fd5b8351925060208401519150604084015190509250925092565b818103600083128015838313168383128216171561564457615644615151565b5092915050565b80820260008212600160ff1b8414161561566757615667615151565b81810583148215176106b6576106b6615151565b60008261568a5761568a61517e565b600160ff1b8214600019841416156156a4576156a4615151565b500590565b6020808252602e908201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160408201526d191e481a5b9a5d1a585b1a5e995960921b606082015260800190565b600082601f83011261570857600080fd5b8151615716614ce582614c9e565b81815284602083860101111561572b57600080fd5b6148f9826020830160208701614e09565b6000806040838503121561574f57600080fd5b825167ffffffffffffffff8082111561576757600080fd5b615773868387016156f7565b9350602085015191508082111561578957600080fd5b50615796858286016156f7565b9150509250929050565b600082516157b2818460208701614e09565b9190910192915050565b602d60f81b8152600082516157d8816001850160208701614e09565b9190910160010192915050565b808201828112600083128015821682158216171561580557615805615151565b505092915050565b6000845161581f818460208901614e09565b8083019050601760f91b808252855161583f816001850160208a01614e09565b6001920191820152835161585a816002840160208801614e09565b0160020195945050505050565b7f416363657373436f6e74726f6c3a206163636f756e742000000000000000000081526000835161589f816017850160208801614e09565b7001034b99036b4b9b9b4b733903937b6329607d1b60179184019182015283516158d0816028840160208801614e09565b01602801949350505050565b6020815260006110b06020830184614e2d565b6000826158fe576158fe61517e565b500690565b60008161591257615912615151565b50600019019056fea2646970667358221220e97f6db8e968034acea6c9108e0a064fc06d35ca54ec19b599f2c74865a4cb8c64736f6c63430008140033';
    // Адрес вашего контракта(прокси контракта если используется)
    private const CONTRACT_ADDRESS = '0x74f094936fd6b64d679c200c159F88DC52c6A352';
    private static ?\SWeb3\SWeb3 $SWeb3;
    private static ?\SWeb3\SWeb3_Contract $contract;

    /**
     * Инициализация объекта SWeb3
     * @return void
     */
    private static function initWeb3(){
        if(!isset(self::$SWeb3)){
            $sweb3 = new SWeb3(self::ETHEREUM_NET_ENDPOINT);
            $sweb3->chainId = self::CHAIN_ID;
            $sweb3->setPersonalData(self::SWP_ADDRESS, self::SWP_PRIVATE_KEY);
            self::$SWeb3 = $sweb3;
        }
    }

    /**
     * Инициализация объекта контракта
     * @return void
     */
    public static function initContract()
    {
        if(!isset(self::$SWeb3)){
            self::initWeb3();
        }
        if(!isset(self::$contract)){
            self::$contract = new SWeb3_contract(self::$SWeb3, self::CONTRACT_ADDRESS, self::CREATION_ABI);
        }
    }

    /**
     * Получение дополнительных параметров для транзакции
     * @return array
     */
    public static function getExtraParams(){
        if(!isset(self::$SWeb3)){
            self::initWeb3();
        }
        return [
            'from' => self::SWP_ADDRESS,
            'nonce' => self::$SWeb3->personal->getNonce(),
            'gasLimit' => 500000,
            'gasPrice' => 1000000000
        ];
    }

    /**
     * Получение истории для указанного кошелька
     * @param string $wallet
     * @return array
     */
    public static function getHystoryWallet(string $wallet):array
    {
        if(!isset(self::$contract)){
            self::initContract();
        }
        try {
            $checkContract = self::$contract->call('getUserHistory', [$wallet]);
            return [
                'status' => 'success',
                'response' => $checkContract
            ];
        }catch (\Exception $e){
            return [
                'status' => 'error',
                'response' => $e
            ];
        }
    }

    /**
     * Покупка VTI из баланса
     * @param float $_USDTAmount
     * @param float $_VTIPrice
     * @param string $_userAddress
     * @param int $_code
     * @return array
     */
    public static function buyVTIfromBalance(
    float $_USDTAmount
    ,float $_VTIPrice
    ,string $_userAddress
    ,int $_code):array
    {
        // dump([
        //     'usdt_amount' => $_USDTAmount,
        //     'vti_price' => $_VTIPrice,
        //     'user_address' => $_userAddress,
        //     'code' => $_code,
        // ]);

        if(!isset(self::$contract)){
            self::initContract();
        }
        $extra_params = self::getExtraParams();
        // try {
            $resultContract = self::$contract->send('buyVTIfromBalance',[
                bcmul($_USDTAmount, 10 ** 18, 0),
                bcmul($_VTIPrice, 10 ** 18, 0),
                $_userAddress,
                $_code,
            ],$extra_params);
            
            if(!isset($resultContract->result)){
                throw new \Exception("Что-то пошло не так, повторите позже");
            }

            $timeout = 50; // Замените на желаемый таймаут в секундах

            $start_time = time();
            $transactionHash = $resultContract->result;

            while (true) {
                $transactionReceipt = self::$SWeb3->call('eth_getTransactionReceipt', [$transactionHash]);
                $status = isset($transactionReceipt->result)? $transactionReceipt->result->status : null;
                if ($status == '0x1') {
                    // Транзакция подтверждена
                    break;
                }

                if (time() - $start_time >= $timeout) {
                    // Превышено время ожидания
                    break;
                }

                sleep(5); // Подождите 5 секунд перед повторной проверкой
            }

            if ($status == '0x0' || !isset($status)) {
                // Таймаут истек, транзакция не подтверждена
                throw new \Exception("Таймаут истек. Транзакция не подтверждена.");
            }

            return [
                'status' => 'success'
            ];
        // }catch (\Exception $e){

        //     return [
        //         'status' => 'error',
        //         'response' => $e,
        //     ];
        // }
    }

    /**
     * Продать на баланс
     * @param float $_VTIAmount
     * @param float $_VTIPrice
     * @param string $_userAddress
     * @param int $_timeStamp
     * @return array
     */
    public static function sellVTIToBalance(
        float $_VTIAmount
        ,float $_VTIPrice
        ,string $_userAddress
        ,int $_timeStamp
    ):array
    {
        if(!isset(self::$contract)){
            self::initContract();
        }
        $extra_params = self::getExtraParams();
        try {
            $resultContract = self::$contract->send('sellVTIToBalance',[
                bcmul($_VTIAmount, 10 ** 18, 0),
                bcmul($_VTIPrice, 10 ** 18, 0),
                $_userAddress,
                $_timeStamp,
            ],$extra_params);

            if(!isset($resultContract->result)){
                throw new \Exception("Что-то пошло не так, повторите позже");
            }

            $timeout = 50; // Замените на желаемый таймаут в секундах

            $start_time = time();
            $transactionHash = $resultContract->result;

            while (true) {
                $transactionReceipt = self::$SWeb3->call('eth_getTransactionReceipt', [$transactionHash]);
                $status = isset($transactionReceipt->result)? $transactionReceipt->result->status : null;
                if ($status == '0x1') {
                    // Транзакция подтверждена
                    break;
                }

                if (time() - $start_time >= $timeout) {
                    // Превышено время ожидания
                    break;
                }

                sleep(5); // Подождите 5 секунд перед повторной проверкой
            }

            if ($status == '0x0' || !isset($status)) {
                // Таймаут истек, транзакция не подтверждена
                throw new \Exception("Таймаут истек. Транзакция не подтверждена.");
            }

            return [
                'status' => 'success'
            ];
        }catch (\Exception $e){
            return [
                'status' => 'error',
                'response' => $e
            ];
        }
    }

    /**
     * Покупка VTI из кошелька
     * @param float $_USDTAmount
     * @param float $_VTIPrice
     * @param string $_userAddress
     * @param int $_timeStamp
     * @param int $_openLimit
     * @param int $_code
     * @return array
     */
    public static function buyVTIfromWallet(
    float $_USDTAmount
    ,float $_VTIPrice
    ,string $_userAddress
    ,int $_timeStamp
    ,int $_openLimit
    ,int $_code):array
    {
        if(!isset(self::$contract)){
            self::initContract();
        }
        $extra_params = self::getExtraParams();
        try {
            $resultContract = self::$contract->send('buyVTI',[
                bcmul($_USDTAmount, 10 ** 18, 0),
                bcmul($_VTIPrice, 10 ** 18, 0),
                $_userAddress,
                $_timeStamp,
                bcmul($_openLimit, 10 ** 18, 0),
                $_code
            ],$extra_params);

            if(!isset($resultContract->result)){
                throw new \Exception("Что-то пошло не так, повторите позже");
            }

            $timeout = 50; // Замените на желаемый таймаут в секундах

            $start_time = time();
            $transactionHash = $resultContract->result;

            while (true) {
                $transactionReceipt = self::$SWeb3->call('eth_getTransactionReceipt', [$transactionHash]);
                $status = isset($transactionReceipt->result)? $transactionReceipt->result->status : null;
                if ($status == '0x1') {
                    // Транзакция подтверждена
                    break;
                }

                if (time() - $start_time >= $timeout) {
                    // Превышено время ожидания
                    break;
                }

                sleep(5); // Подождите 5 секунд перед повторной проверкой
            }

            if ($status == '0x0' || !isset($status)) {
                // Таймаут истек, транзакция не подтверждена
                throw new \Exception("Таймаут истек. Транзакция не подтверждена.");
            }

            return [
                'status' => 'success'
            ];
        }catch (\Exception $e){
            return [
                'status' => 'error',
                'response' => $e
            ];
        }
    }

    /**
     * Продажа VTI из баланса
     * @param float $_VTIAmount
     * @param float $_VTIPrice
     * @param string $_userAddress
     * @param int $_timeStamp
     * @return array
     */
    public static function sellVTI(
        float $_VTIAmount
        ,float $_VTIPrice
        ,string $_userAddress
        ,int $_timeStamp):array
    {
        if(!isset(self::$contract)){
            self::initContract();
        }
        $extra_params = self::getExtraParams();
        try {
            $resultContract = self::$contract->send('sellVTI',[
                bcmul($_VTIAmount, 10 ** 18, 0),
                bcmul($_VTIPrice, 10 ** 18, 0),
                $_userAddress,
                $_timeStamp,
            ],$extra_params);

            if(!isset($resultContract->result)){
                throw new \Exception("Что-то пошло не так, повторите позже");
            }

            $timeout = 50; // Замените на желаемый таймаут в секундах

            $start_time = time();
            $transactionHash = $resultContract->result;

            while (true) {
                $transactionReceipt = self::$SWeb3->call('eth_getTransactionReceipt', [$transactionHash]);
                $status = isset($transactionReceipt->result)? $transactionReceipt->result->status : null;
                if ($status == '0x1') {
                    // Транзакция подтверждена
                    break;
                }

                if (time() - $start_time >= $timeout) {
                    // Превышено время ожидания
                    break;
                }

                sleep(5); // Подождите 5 секунд перед повторной проверкой
            }

            if ($status == '0x0' || !isset($status)) {
                // Таймаут истек, транзакция не подтверждена
                throw new \Exception("Таймаут истек. Транзакция не подтверждена.");
            }

            return [
                'status' => 'success'
            ];
        }catch (\Exception $e){
            return [
                'status' => 'error',
                'response' => $e
            ];
        }
    }

    public static function getAllUserPrograms(string $wallet):array
    {
        if(!isset(self::$contract)){
            self::initContract();
        }
        try {
            $checkContract = self::$contract->call('getAllUserPrograms', [$wallet]);
            return [
                'status' => 'success',
                'response' => $checkContract
            ];
        }catch (\Exception $e){
            return [
                'status' => 'error',
                'response' => $e
            ];
        }
    }
}
